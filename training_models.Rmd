---
title: "Training_models"
author: "Iris Hoekstra"
date: "15/7/2022"
output: pdf_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
knitr::opts_chunk$set(fig.width=12, fig.height=12) 

library(ggplot2)
library(reshape2)
library("ensembleMOS")
library(verification)
library(SpecsVerification)
library(crch)
library(kableExtra)
library(gridExtra)

for (k in 1:8){
  df <- read.table(paste0("tot.train.",sprintf("%02d",seq(6,48,by=6))[k],".csv"), sep = ",", header= T)
  df <- df[-c(seq(7786,7830)),] #min date 22-11-2021
  df.na <-  df[-c(which(is.na(df[,22]))),]
  assign(paste0("long" ,sprintf("%02d",seq(6,48,by=6))[k]),df) 
  #assign(paste0("long" ,sprintf("%02d",seq(6,48,by=6))[k],".rmna"),df.na) 
}

for(k in 1:8){
 df = read.table(paste0("wide.control." ,sprintf("%02d",seq(6,48,by=6))[k],"h.csv"),header=T, sep=",")
  assign(paste0("wide.control." ,sprintf("%02d",seq(6,48,by=6))[k],"h"),df)
}

for(k in 1:8){
  df = read.table(paste0("wide.control.5x5." ,sprintf("%02d",seq(6,48,by=6))[k],"h.csv"),header=T, sep=",")
  assign(paste0("control.5x5." ,sprintf("%02d",seq(6,48,by=6))[k],"h"),df)
}

```

#   Raw ensemble: RMSE 

```{r,include =F}
calculate.rmse <- function(data){
  data <- na.omit(data)
  rmse <- rep(NA,7)
  index <- matrix(seq(4,21),nrow=3)
  rmse[1] <- sqrt(mean((data[,3] - data$observation)^2))
  for (i in 1:6){
    rmse[i+1] <- sqrt(mean(((rowSums(data[,c(index[,i])])/3)-data$observation)^2)) }
  print(rmse)}

rmse.df <- matrix(nrow=7,ncol=8)
for (i in 1:8){
  rmse.df[,i] <- calculate.rmse(na.omit(get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))))
}

colnames(rmse.df)<-paste0(seq(6,48,by=6),"h")
rownames(rmse.df )<- paste("mini-ens",seq(0,6))
rownames(rmse.df)[1] <- " control"

kbl(rmse.df, booktabs=T, caption= "Root Mean Squared Error per mini ensemble, per leadtime")

rmse.plot <-data.frame(lead=(seq(6,48,by=6)),rmse=colMeans(rmse.df))
df <- melt(rmse.df)  #the function melt reshapes it from wide to long
colnames(df)<-c("member","lead","RMSE")
df$member<-as.factor(df$member)
```


```{r,fig.width=8, fig.height=6}
ggplot(df, aes(lead, RMSE, group=(member))) + geom_line(aes(color=member))+ theme_grey(base_size=15,) + xlab("Lead time")

#+theme(axis.text.x=element_text(size=15),axis.text.y=element_text(size=15),legend.text=element_text(size=15),legend.title=element_text(size=15), axis.title.x = element_text(size = 15),  axis.title.y = element_text(size = 15),title=element_text(size=15))
```




```{r,include =F}
df <- melt(rmse.df)  #the function melt reshapes it from wide to long
colnames(df)<-c("member","lead_time","RMSE")
grid.arrange(
  ggplot()+geom_line(data=rmse.plot,aes(x=lead,y=rmse))+scale_x_continuous(breaks=seq(6,48,by=6))+
  ggtitle("Average RMSE"), 
  ggplot(df, aes(member, RMSE, group=factor(lead_time))) + geom_line(aes(color=factor(lead_time)))+ggtitle("RMSE per member"), 
  ggplot(df, aes(lead_time, RMSE, group=factor(member))) + geom_line(aes(color=factor(member)))+ggtitle("RMSE over lead time"),ncol=3)

```

#   Model 1: Raw ensemble
```{r,fig.width=12, fig.height=4}
par(mfrow=c(2,4))
for(i in 1:8){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
 rank <- apply(df[, 3:21], 1, rank)[1,]
hist(rank,main = paste0("Lead time ",sprintf("%02d",seq(6,48,by=6))[i],"h"), freq = T,breaks=15)}
```
#   Truncated Normal & Log-normal
#    Model 2: TN All exchangeable (same parameter)

EMOS truncated normal:

For each forecasting occasion t (lead time t):
$y_t \sim N_0[\mu_t, \sigma²_t]$
$\mu = a_0 + \beta_1  x_{t,1} + \beta_2  x_{t,2} + ... + \beta_m  x_{t,m}$ for non exchangeable members
$\sigma^2= c +d*S_t^2$
where $x_{t,k}$ is the kth ensemble member fro the tth forecast, $s^2_t$ is the ensemble variance:
$s²_t= \frac{1}{m} \sum^m_{k=1}(x_{t,k}-\bar{x}_t)²$
m is the ensemble size and the ensemble mean is:
$\bar{x_t}= \frac{1}{m}\sum^m_{k=1}x_{t,k}$

##   Model programming
```{r}

model2.function<-function(model){
model.df <- data.frame(lead=seq(6,48,by=6),intercept=NA,coefB=NA,coefC=NA,coefD=NA, crps.raw=NA, crps.train=NA,crps.cv=NA,crps.boot=NA)
cv.crps<-matrix(ncol=5,nrow=8)
for(i in 1:8){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
  df.train <- ensembleData(forecasts=df[,3:21],dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19))
mos <- fitMOS(df.train, model = model)

model.df[i,2]<-mos$a
model.df[i,3]<-mos$B[1]
model.df[i,4]<-mos$c
model.df[i,5]<-mos$d
model.df[i,6]<-colMeans(ensembleMOS::crps(mos, na.omit(df.train)))[1]
model.df[i,7]<-colMeans(ensembleMOS::crps(mos, na.omit(df.train)))[2]

for(j in 1:5){
cv.index <- matrix(data=c(1:7785),ncol=5)
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = model)
cv.crps[i,j]<-colMeans(ensembleMOS::crps(mos, na.omit(df.train[c(cv.index[,j]),])))[2]}
model.df[i,8]<-mean(cv.crps[i,])}


return(model.df)}
```

```{r}
model2.df <- model2.function("truncnormal")
```

##    Verification 

###   CV

###   PIT Histogram - CV
```{r,fig.width=12, fig.height=4}
par(mfrow=c(2,4))
c.test<-rep(NA,8)

for(i in 1:8){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i])) 
cv.index <- matrix(data=c(1:7785),ncol=5)
df.train<-ensembleData(forecasts=df[,3:21],dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19))
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = 'truncnormal')
assign(paste0('fold',j),pars(mos, df.train[c(cv.index[,j]),])) }
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- na.omit(data.frame(na.omit(df.train$observations),folds))

c.test[i] <- verification::crps(df.crps[,1], df.crps[,2:3])$CRPS 
hist(ptnorm(df.crps[,1],df.crps[,2],df.crps[,3],left=0),main= paste0("Lead time ",sprintf("%02d",seq(6,48,by=6))[i],"h"), xlab = "Probability", ylab="Frequency",breaks=15)}

```

###   CRPS (by cross-validation) & Bootstrap 
```{r}
model2.df$crps.cv.total <- c.test
model2.df[,c(1,6,7,8,9)]
```

Bootstrap CRPS & BS:

```{r}
set.seed(123)
bootsample <- function(){
  index <- matrix(seq(1,7785),ncol =173)
  bindex <- matrix(ncol=173,nrow=1000)
  for(i in 1:250){
  bindex[i,]=sample(1:173,173, replace=T)}
 return(bindex)}
boot.index=bootsample()

bootstrap.crps2<-function(model){
scores=vector(mode="list",length=8)
for(i in 1:8){
  score.bs <- rep(NA,250)
  for (k in 1:250){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))[boot.index[k,],]
  df.train <- ensembleData(forecasts=df[,3:21],dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19))
  mos <- fitMOS(df.train, model = model)
  score.bs[k] <- colMeans(ensembleMOS::crps(mos, na.omit(df.train)))}
scores[[i]]<- score.bs
}
return(scores)}

scores.mod2 <- bootstrap.crps2("truncnormal")
names(scores.mod2)<- seq(6,48,by=6)
boxplot(scores.mod2,ylab="CRPS",xlab= "Lead", main="Bootstrapped CRPS model 2") #for each test model

scores.mod5 <- 
```


###   Brier Skill Score
```{r}
my_stations <- read.table("stat.data.index.csv", header=T, sep=",")[-35,1:3]
colnames(my_stations)<-c("SID","LON","LAT")
stat.number = rep(NA,45)
for(i in 1:45){
stat.numbers[i] <- strsplit(my_stations$SID,split="_")[[i]][1]}
coast_sta = c(258,249,248,313,308,310,311,315,312,323,324,331,330,343,344,210,215,286,240,209,225,257,235,242,251,270,277,267,285,316)
coast.index2=ifelse(stat.numbers %in% coast_sta,1,0)
```


```{r}
par(mfrow=c(3,1))
bs.train.2<-function(model){
bs <- data.frame(thresholds = seq(2,24,by=2))
thresholds <- seq(2,24,by=2)
coast.index.mat = rep(coast.index,173)
brier.land<-matrix(nrow=8,ncol=12)
brier.coast=matrix(nrow=8,ncol=12)

for(i in 1:8){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
  cv.index <- matrix(data=c(1:7785),ncol=5)
    df.train <- ensembleData(forecasts=df[,3:21],dates=df$date,
                           observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                           initializationTime = "00", exchangeable = rep(1,19))
  df.train$coast = coast.index.mat
  coast.index = na.omit(df.train)$coast
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = model)
assign(paste0('fold',j),cdf(mos, df.train[c(cv.index[,j]),],thresholds)) }
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- (data.frame((df.train$observations),folds))
for(j in 1:12){
brier.coast[i,j] = brier(obs=ifelse(df.crps[coast.index==1,1] <thresholds[j],1,0), df.crps[coast.index==1,j+1],bins=F)$ss
brier.land[i,j] = brier(obs=ifelse(df.crps[coast.index==0,1] <thresholds[j],1,0), df.crps[coast.index==0,j+1],bins=F)$ss}
}
bss.test<-list(brier.coast,brier.land)
return(bss.test)}

bss.train.mod2 <- bs.train.2('truncnormal')
bss.train.mod5 <- bs.train.2("lognormal")
save(bss.train.mod2,bss.train.mod5, file="newbrier.trainingset.RData")
```


###   Bootstrapped Brier (Skill) Score

```{r}
bootstrap.brier2<-function(model){
  bs <- data.frame(thresholds = seq(2,24,by=2))
  thresholds <- seq(2,24,by=2)
scores=vector(mode="list",length=8)
for(i in 1:8){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))[boot.index,]
  df.train <- ensembleData(forecasts=df[,3:21],dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19))
mos <- fitMOS(df.train, model = model)
cdf.brier <- cdf(mos, df.train,thresholds)
for(j in 1:12){
bs[j,paste0("BS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.train$observations<thresholds[j],1,0), cdf.brier[,j],bins=F)$bs
bs[j,paste0("SS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.train$observations<thresholds[j],1,0), cdf.brier[,j],bins=F)$ss} }
return(bs)}

bootstrap.brier2("truncnormal")
```



###   Reliability Diagram 

```{r, fig.size=3,fig.width=3}
par(mfrow=c(2,1))
thresholds <- seq(2,24,by=2)
rel.plot <-function(k,model){
for(i in 1:8){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
  cv.index <- matrix(data=c(1:7785),ncol=5)
  df.train <- ensembleData(forecasts=df[,3:21],dates=df$date,
                           observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                           initializationTime = "00", exchangeable = rep(1,19))
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = model)
assign(paste0('fold',j),cdf(mos, df.train[c(cv.index[,j]),],thresholds)) }

folds <- rbind(fold1,fold2,fold3,fold4,fold5)

p <- ifelse(((1 - folds[,k]) <0),0,1- (folds[,k]))
ReliabilityDiagram(p, (df.train$observation > thresholds[k]), plot=TRUE, handle.na="use.pairwise.complete")}
}

rel.plot(k=3,model="truncnormal") #threshold 14 -> threshold 6
rel.plot(k=8,model="truncnormal") #threhsold 16
rel.plot(k=9,model="truncnormal") #threshold 18

```


#    Model 3: TN Separate parameters per mini ensemble 

##    Model specification

```{r}
model3.function<-function(model){
model.df <- data.frame(lead=seq(6,48,by=6),intercept=NA,coefB1=NA,coefB2=NA,coefB3=NA,coefB4=NA,coefB5=NA,coefB6=NA,coefB7=NA,coefC=NA,coefD=NA,crps.raw=NA, crps.train=NA,crps.cv=NA)
cv.crps <- matrix(ncol=5,nrow=8)

for(i in 1:8){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
  df.train <- ensembleData(forecasts=df[3:21],dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = c(1,rep(2:7,each=3)))
mos <- fitMOS(df.train, model = model)

model.df[i,2]<-mos$a
for(j in 1:7){
model.df[i,2+j]<-mos$B[c(1,2,5,8,11,14,17)[j]]}
model.df[i,10]<-mos$c
model.df[i,11]<-mos$d
model.df[i,12]<-colMeans(ensembleMOS::crps(mos, na.omit(df.train)))[1]
model.df[i,13]<-colMeans(ensembleMOS::crps(mos, na.omit(df.train)))[2]

for(j in 1:5){
cv.index <- matrix(data=c(1:7785),ncol=5)
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = model)
cv.crps[i,j]<-colMeans(ensembleMOS::crps(mos, na.omit(df.train[c(cv.index[,j]),])))[2]}
  model.df[i,14]<-mean(cv.crps[i,])
}
return(model.df)}
```


```{r}
model3.df <- model3.function("truncnormal")
```


##    Verification 

###   CRPS (by cross-validation) & Bootstrap 
```{r}
par(mfrow=c(4,2))
cp.test.mod3 <- rep(NA,8)
cv.index <- matrix(data=c(1:7785),ncol=5)
for(i in 1:8){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i])) 
df.train <- ensembleData(forecasts=df[3:21],dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = c(1,rep(2:7,each=3)))
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = 'truncnormal')
assign(paste0('fold',j),pars(mos, df.train[c(cv.index[,j]),])) }
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- na.omit(data.frame(na.omit(df.train$observations),folds))
cp.test.mod3[i] <- verification::crps(df.crps[,1], df.crps[,2:3])$CRPS 
hist(ptnorm(df.crps[,1],df.crps[,2],df.crps[,3],left=0),main= paste0("PIT histgram,  lead ",seq(6,48,by=6)[i]), xlab = "Probability", ylab="Frequency")}
model3.df$crps.totalcv <-cp.test.mod3
model3.df[,c(1,12,13,14,15)]
```


```{r}
###   Bootstrap CRPS
crps.mod3 <- NULL

for (j in 1:8){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[j]))
  df.train <- ensembleData(forecasts=df[,3:21],dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[j],
                               initializationTime = "00", exchangeable = c(1,rep(2:7,each=3)))
mos <- fitMOS(df.train, model = "truncnormal")
scores <- bootmean(ensembleMOS::crps(mos, na.omit(df.train))[,2])
crps.mod3 <- cbind(crps.mod3,scores)}

colnames(crps.mod3) <- paste0(seq(6,48,by=6))

boxplot(crps.mod3,ylab="CRPS",xlab= "Lead", main="Bootstrapped CRPS model 3") #for each test model
colMeans(crps.mod3)
model3.df
```


###   Brier Skill Score
```{r}
bs.train.3<-function(model){
bs <- data.frame(thresholds = seq(2,24,by=2))
thresholds <- seq(2,24,by=2)
coast.index.mat = rep(coast.index,173)
brier.land<-matrix(nrow=8,ncol=12)
brier.coast=matrix(nrow=8,ncol=12)

for(i in 1:8){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
  cv.index <- matrix(data=c(1:7785),ncol=5)
    df.train <- ensembleData(forecasts=df[3:21],dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = c(1,rep(2:7,each=3)))
  df.train$coast = coast.index.mat
  coast.index = na.omit(df.train)$coast
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = model)
assign(paste0('fold',j),cdf(mos, df.train[c(cv.index[,j]),],thresholds)) }
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- (data.frame((df.train$observations),folds))
for(j in 1:12){
brier.coast[i,j] = brier(obs=ifelse(df.crps[coast.index==1,1] <thresholds[j],1,0), df.crps[coast.index==1,j+1],bins=F)$ss
brier.land[i,j] = brier(obs=ifelse(df.crps[coast.index==0,1] <thresholds[j],1,0), df.crps[coast.index==0,j+1],bins=F)$ss}
}
bss.test<-list(brier.coast,brier.land)
return(bss.test)}

bss.train.mod3 <- bs.train.3('truncnormal')
bss.train.mod6 <- bs.train.3("lognormal")
save(bss.train.mod2,bss.train.mod5, bss.train.mod3 ,bss.train.mod6,file="newbrier.trainingset.RData")
```

OUD
```{r}
par(mfrow=c(4,2))
bs3 <- data.frame(thresholds = seq(2,24,by=2))

thresholds <- seq(2,24,by=2)
for(i in 1:8){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
  df.train <- ensembleData(forecasts=df[3:21],dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = c(1,rep(2:7,each=3)))
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = 'truncnormal')
assign(paste0('fold',j),cdf(mos, df.train[c(cv.index[,j]),],thresholds)) }
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- (data.frame((df.train$observations),folds))

for(j in 1:12){
bs3[j,paste0("BS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$bs
bs3[j,paste0("SS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$ss} }

par(mfrow=c(4,3))
for (j in 1:10){
  plot(y=as.numeric(bs3[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Skill Score,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Skill Score")
  abline(h=0)}
```


```{r}
par(mfrow=c(4,3))
for (j in 1:12){
  plot(y=as.numeric(bs3[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Score, threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Score")}

```

```{r, fig.size=3,fig.width=3}
rel.plot3 <-function(k){
for(i in 1:8){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
  df.train <- ensembleData(forecasts=df[3:21],dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = c(1,rep(2:7,each=3)))
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = 'truncnormal')
assign(paste0('fold',j),cdf(mos, df.train[c(cv.index[,j]),],thresholds)) }
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
p <- ifelse(((1 - folds[,k]) <0),0,1- (folds[,k]))
ReliabilityDiagram(p, (df.train$observation > thresholds[k]), plot=TRUE, handle.na="use.pairwise.complete")}
}

rel.plot3(k=7)
rel.plot3(k=8)
rel.plot3(k=9)
```


#   Model 4: Weighted Ensemble Averaging
4.1: weights rmse
4.2: weights mse
4.3: linear weights (control -> 6)
4.4: weights linear based on rmse
4.5: weights linear no control 
4.6: correlations
4.7: weights linear control weight 1

##   Model 4.1	Weights function: based on RMSE
```{r}
model4.1.function<-function(model, weights){

model.df <- data.frame(lead=seq(6,48,by=6),intercept=NA,coefB=NA,coefC=NA,coefD=NA,crps.raw=NA, crps.train=NA,crps.cv=NA)
cv.crps <- matrix(ncol=5,nrow=8)

for(i in 1:8){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
weighted.df <- ((t(t(df[,3:21])*weights[,i]))) 
weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19)) 
mos <- fitMOS(weighted.ED, model= model)
model.df[i,2]<-mos$a
model.df[i,3]<-mos$B[1]
model.df[i,4]<-mos$c
model.df[i,5]<-mos$d
model.df[i,6]<-colMeans(ensembleMOS::crps(mos, na.omit(weighted.ED)))[1]
model.df[i,7]<-colMeans(ensembleMOS::crps(mos, na.omit(weighted.ED)))[2]

for(j in 1:5){
cv.index <- matrix(data=c(1:7785),ncol=5)
mos <- fitMOS(weighted.ED[-c(cv.index[,j]),], model = model)
cv.crps[i,j]<-colMeans(ensembleMOS::crps(mos, na.omit(weighted.ED[c(cv.index[,j]),])))[2]}
  model.df[i,8]<-mean(cv.crps[i,])
}
return(model.df)}
```

```{r}
w <- 1/rmse.df
weights.rmse <- t(t(w)/colSums(w))*7
weights.rmse.df <- rbind(weights.rmse[1,],weights.rmse[2,],weights.rmse[2,],weights.rmse[2,],weights.rmse[3,],weights.rmse[3,],weights.rmse[3,],weights.rmse[4,],weights.rmse[4,],weights.rmse[4,], weights.rmse[5,],weights.rmse[5,],weights.rmse[5,],weights.rmse[6,],weights.rmse[6,],weights.rmse[6,],weights.rmse[7,],weights.rmse[7,],weights.rmse[7,])

model4.1.df <- model4.1.function("truncnormal", weights.rmse.df)
```

Verification: CRPS cv 
```{r}
par(mfrow=c(4,2))
cp.test.mod4.1 <- rep(NA,8)
for(i in 1:8){
df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i])) 
cv.index <- matrix(data=c(1:7785),ncol=5)
weighted.df <- ((t(t(df[,3:21])*weights.rmse.df[,i]))) 
weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19)) 

for(j in 1:5){
mos <- fitMOS(weighted.ED[-c(cv.index[,j]),], model = 'truncnormal')
assign(paste0('fold',j),pars(mos, weighted.ED[c(cv.index[,j]),])) } 

folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- na.omit(data.frame(na.omit(weighted.ED$observations),folds))
cp.test.mod4.1[i] <- verification::crps(df.crps[,1], df.crps[,2:3])$CRPS 
hist(ptnorm(df.crps[,1],df.crps[,2],df.crps[,3],left=0),main= paste0("PIT histgram,  lead ",seq(6,48,by=6)[i]), xlab = "Probability", ylab="Frequency", breaks = 20)}

model4.1.df$crps.totalcv <-cp.test.mod4.1
model4.1.df[,c(1,7,8,9)]
```

###   Brier Skill Score

```{r}
bs.train.4<-function(model,weights){
bs <- data.frame(thresholds = seq(2,24,by=2))
thresholds <- seq(2,24,by=2)
coast.index.mat = rep(coast.index,173)
brier.land<-matrix(nrow=8,ncol=12)
brier.coast=matrix(nrow=8,ncol=12)

for(i in 1:8){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
  cv.index <- matrix(data=c(1:7785),ncol=5)
  weighted.df <- ((t(t(df[,3:21])*weights[,i]))) 
  weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19)) 
df.train <- weighted.ED 
df.train$coast = coast.index.mat
coast.index = na.omit(df.train)$coast
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = model)
assign(paste0('fold',j),cdf(mos, df.train[c(cv.index[,j]),],thresholds)) }
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- (data.frame((df.train$observations),folds))
for(j in 1:12){
brier.coast[i,j] = brier(obs=ifelse(df.crps[coast.index==1,1] <thresholds[j],1,0), df.crps[coast.index==1,j+1],bins=F)$ss
brier.land[i,j] = brier(obs=ifelse(df.crps[coast.index==0,1] <thresholds[j],1,0), df.crps[coast.index==0,j+1],bins=F)$ss}
}
bss.test<-list(brier.coast,brier.land)
return(bss.test)}

bss.train.mod4.1 <- bs.train.4('truncnormal',weights.rmse.df)
bss.train.mod4.2 <- bs.train.4("truncnormal",weights.mse.df)
bss.train.mod4.3 <- bs.train.4("truncnormal",weights.lin)
bss.train.mod4.4 <- bs.train.4("truncnormal",weight.lin.rmse)
bss.train.mod7.1 <- bs.train.4("lognormal",weights.rmse.df)
bss.train.mod7.2 <- bs.train.4("lognormal",weights.mse.df)
bss.train.mod7.3 <- bs.train.4("lognormal",weights.lin)
bss.train.mod7.4 <- bs.train.4("lognormal",weight.lin.rmse)

save(bss.train.mod2,bss.train.mod5, bss.train.mod3 ,bss.train.mod6,file="newbrier.trainingset.RData")
```

```{r}
par(mfrow=c(4,2))
bs4.1 <- data.frame(thresholds = seq(2,24,by=2))
thresholds <- seq(2,24,by=2)
for(i in 1:8){
df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
weighted.df <- ((t(t(df[,3:21])*weights.rmse.df[,i]))) 

weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19)) 
df.train <- weighted.ED 
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = 'truncnormal')
assign(paste0('fold',j),cdf(mos, df.train[c(cv.index[,j]),],thresholds)) }
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- (data.frame((df.train$observations),folds))
for(j in 1:12){
bs4.1[j,paste0("BS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$bs
bs4.1[j,paste0("SS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$ss} }

par(mfrow=c(4,3))
for (j in 1:11){
  plot(y=as.numeric(bs4.1[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Skill Score,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Skill Score")
  abline(h=0)}
```


```{r}
par(mfrow=c(4,3))
for (j in 1:12){
  plot(y=as.numeric(bs4.1[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Score, threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Score")}

```

##   Model 4.2 Weights based on MSE
```{r}
w <- 1/(rmse.df^2)
weights.mse <- t(t(w)/colSums(w))*7
weights.mse.df <- rbind(weights.mse[1,],weights.mse[2,],weights.mse[2,],weights.mse[2,],weights.mse[3,],weights.mse[3,],weights.mse[3,],weights.mse[4,],weights.mse[4,],weights.mse[4,], weights.mse[5,],weights.mse[5,],weights.mse[5,],weights.mse[6,],weights.mse[6,],weights.mse[6,],weights.mse[7,],weights.mse[7,],weights.mse[7,])
model4.2.df <- model4.1.function("truncnormal", weights.mse.df)
```

###   Verification: CRPS cv 
```{r}
par(mfrow=c(4,2))
cp.test.mod4.2 <- rep(NA,8)
for(i in 1:8){
df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i])) 
cv.index <- matrix(data=c(1:7885),ncol=5)
weighted.df <- ((t(t(df[,3:21])*weights.mse.df[,i]))) 
weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19)) 

for(j in 1:5){
mos <- fitMOS(weighted.ED[-c(cv.index[,j]),], model = 'truncnormal')
assign(paste0('fold',j),pars(mos, weighted.ED[c(cv.index[,j]),])) } 

folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- na.omit(data.frame(na.omit(weighted.ED$observations),folds))
cp.test.mod4.2[i] <- verification::crps(df.crps[,1], df.crps[,2:3])$CRPS 
hist(ptnorm(df.crps[,1],df.crps[,2],df.crps[,3],left=0),main= paste0("PIT histogram,  lead ",seq(6,48,by=6)[i]), xlab = "Probability", ylab="Frequency",breaks=20)}

model4.2.df$crps.totalcv <-cp.test.mod4.2
model4.2.df[,c(1,7,8,9)]
```


###   Brier Skill Score

```{r}
par(mfrow=c(4,2))
bs4.2 <- data.frame(thresholds = seq(2,24,by=2))
thresholds <- seq(2,24,by=2)
for(i in 1:8){
df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
weighted.df <- ((t(t(df[,3:21])*weights.mse.df[,i]))) 

weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19)) 
df.train <- weighted.ED 
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = 'truncnormal')
assign(paste0('fold',j),cdf(mos, df.train[c(cv.index[,j]),],thresholds)) }
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- (data.frame((df.train$observations),folds))
for(j in 1:12){
bs4.2[j,paste0("BS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$bs
bs4.2[j,paste0("SS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$ss} }


par(mfrow=c(4,3))
for (j in 1:11){
  plot(y=as.numeric(bs4.2[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Skill Score,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Skill Score")
  abline(h=0)}
```


```{r}
par(mfrow=c(4,3))
for (j in 1:11){
  plot(y=as.numeric(bs4.2[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Model 4.2: Brier Score, threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Score")}
```

##   Model 4.3 Weights based on age (linear decreasing)
```{r}
w3 <- seq(1,0,by=-1/6)[1:6]
w3.1<-w3/sum(w3)*6
repw.3 <- c(1,w3.1[rep(1:6,each=3)])
weights.lin <- data.frame(repw.3,repw.3,repw.3,repw.3,repw.3,repw.3,repw.3,repw.3)

model4.3.df <- model4.1.function("truncnormal", weights.lin)
```

###   Verification: CRPS cv 
```{r}
par(mfrow=c(4,2))
cp.test.mod4.3 <- rep(NA,8)
for(i in 1:8){
df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i])) 

weighted.df <- ((t(t(df[,3:21])*weights.lin[,i]))) 
weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19)) 

for(j in 1:5){
mos <- fitMOS(weighted.ED[-c(cv.index[,j]),], model = 'truncnormal')
assign(paste0('fold',j),pars(mos, weighted.ED[c(cv.index[,j]),])) } 

folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- na.omit(data.frame(na.omit(weighted.ED$observations),folds))
cp.test.mod4.3[i] <- verification::crps(df.crps[,1], df.crps[,2:3])$CRPS 
hist(ptnorm(df.crps[,1],df.crps[,2],df.crps[,3],left=0),main= paste0("PIT histogram,  lead ",seq(6,48,by=6)[i]), xlab = "Probability", ylab="Frequency")}

model4.3.df$crps.totalcv <-cp.test.mod4.3

model4.3.df[,c(1,6:9)]
```


###   Brier Skill Score

```{r}
par(mfrow=c(4,2))
bs4.3 <- data.frame(thresholds = seq(2,24,by=2))
thresholds <- seq(2,24,by=2)

for(i in 1:8){
df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
weighted.df <- ((t(t(df[,3:21])*weights.lin[,i]))) 

weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19)) 
df.train <- weighted.ED 
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = 'truncnormal')
assign(paste0('fold',j),cdf(mos, df.train[c(cv.index[,j]),],thresholds)) }
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- (data.frame((df.train$observations),folds))
for(j in 1:12){
bs4.3[j,paste0("BS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$bs
bs4.3[j,paste0("SS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$ss} }

par(mfrow=c(4,3))
for (j in 1:12){
  plot(y=as.numeric(bs4.3[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Model 4.3: Brier Score, threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Score")}
```


```{r}
par(mfrow=c(4,3))
for (j in 1:11){
  plot(y=as.numeric(bs4.3[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Model 4.3: Brier Skill Score,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Skill Score")
  abline(h=0)}
```

##  Model 4.4 Weights based on rank RMSE, linear decreasing 
```{r}
w4 <- seq(1,0,by=-1/6)[1:6]
weight.lin.rmse <- matrix(data=NA, nrow=6,ncol=8)
for(i in 1:8){
weight.lin.rmse[,i]<-(w4[rank(rmse.df[-1,i])])/3.5}
w4.new <- rbind(1,weight.lin.rmse*6)
colMeans(w4.new)

weights.lin.rmse.df <- rbind(w4.new[1,],w4.new[2,],w4.new[2,],w4.new[2,],w4.new[3,],w4.new[3,],w4.new[3,],w4.new[4,],w4.new[4,],w4.new[4,], w4.new[5,],w4.new[5,],w4.new[5,],w4.new[6,],w4.new[6,],w4.new[6,],w4.new[7,],w4.new[7,],w4.new[7,])

model4.4.df <- model4.1.function("truncnormal", weights.lin.rmse.df)

```

###    Verification: CRPS cv 
```{r}
par(mfrow=c(4,2))
cp.test.mod4.4 <- rep(NA,8)
for(i in 1:8){
df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i])) 
weighted.df <- ((t(t(df[,3:21])*weights.lin.rmse.df[,i]))) 
weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19))
for(j in 1:5){
mos <- fitMOS(weighted.ED[-c(cv.index[,j]),], model = 'truncnormal')
assign(paste0('fold',j),pars(mos, weighted.ED[c(cv.index[,j]),])) } 
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- na.omit(data.frame(na.omit(weighted.ED$observations),folds))
cp.test.mod4.4[i] <- verification::crps(df.crps[,1], df.crps[,2:3])$CRPS 
hist(ptnorm(df.crps[,1],df.crps[,2],df.crps[,3],left=0),main= paste0("PIT histogram,  lead ",seq(6,48,by=6)[i]), xlab = "Probability", ylab="Frequency")}

model4.4.df$crps.totalcv <-cp.test.mod4.4

model4.4.df[,c(1,6:9)]

```

###   Brier Skill Score

```{r}
bs4.4 <- data.frame(thresholds = seq(2,24,by=2))
thresholds <- seq(2,24,by=2)

for(i in 1:8){
df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
weighted.df <- ((t(t(df[,3:21])*weights.lin.rmse.df[,i]))) 
weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19)) 
df.train <- weighted.ED 
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = 'truncnormal')
assign(paste0('fold',j),cdf(mos, df.train[c(cv.index[,j]),],thresholds)) }
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- (data.frame((df.train$observations),folds))
for(j in 1:12){
bs4.4[j,paste0("BS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$bs
bs4.4[j,paste0("SS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$ss} }

par(mfrow=c(4,3))
for (j in 1:12){
  plot(y=as.numeric(bs4.4[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Model 4.4: Brier Score, threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Score")}
```


```{r}
par(mfrow=c(4,3))
for (j in 1:11){
  plot(y=as.numeric(bs4.4[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Model 4.4: Brier Skill Score,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Skill Score")
  abline(h=0)}

```

##    BSS Mod 4.1-4.6

```{r}
bs.train.4<-function(model,weights){
bs <- data.frame(thresholds = seq(2,24,by=2))
thresholds <- seq(2,24,by=2)
coast.index.mat = rep(coast.index2,173)
brier.land<-matrix(nrow=8,ncol=12)
brier.coast=matrix(nrow=8,ncol=12)

for(i in 1:8){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
  cv.index <- matrix(data=c(1:7785),ncol=5)
  weighted.df <- ((t(t(df[,3:21])*weights[,i]))) 
  weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19)) 
df.train <- weighted.ED 
df.train$coast = coast.index.mat
coast.index = na.omit(df.train)$coast
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = model)
assign(paste0('fold',j),cdf(mos, df.train[c(cv.index[,j]),],thresholds)) }
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- (data.frame((df.train$observations),folds))
for(j in 1:12){
brier.coast[i,j] = brier(obs=ifelse(df.crps[coast.index==1,1] <thresholds[j],1,0), df.crps[coast.index==1,j+1],bins=F)$ss
brier.land[i,j] = brier(obs=ifelse(df.crps[coast.index==0,1] <thresholds[j],1,0), df.crps[coast.index==0,j+1],bins=F)$ss}
}
bss.test<-list(brier.coast,brier.land)
return(bss.test)}

bss.train.mod4.1 <- bs.train.4('truncnormal',weights.rmse.df)
bss.train.mod4.2 <- bs.train.4("truncnormal",weights.mse.df)
bss.train.mod4.3 <- bs.train.4("truncnormal",weights.lin)
bss.train.mod4.4 <- bs.train.4("truncnormal",weight.lin.rmse)
bss.train.mod7.1 <- bs.train.4("lognormal",weights.rmse.df)
bss.train.mod7.2 <- bs.train.4("lognormal",weights.mse.df)
bss.train.mod7.3 <- bs.train.4("lognormal",weights.lin)
bss.train.mod7.4 <- bs.train.4("lognormal",weight.lin.rmse)

save(bss.train.mod2,bss.train.mod5, bss.train.mod3 ,bss.train.mod6,bss.train.mod4.1,bss.train.mod4.2,bss.train.mod4.3,bss.train.mod4.4,bss.train.mod7.1,bss.train.mod7.2,bss.train.mod7.3,bss.train.mod7.4,bss.train.mod7.6,bss.train.mod7.5,bss.train.mod4.5,bss.train.mod4.6,file="newbrier.trainingset.RData")
```


##   Model 4.5 Weights based on age, without control as predictor
```{r}
model4.5.function<-function(model, weights){
model.df <- data.frame(lead=seq(6,48,by=6),intercept=NA,coefB=NA,coefC=NA,coefD=NA,crps.raw=NA, crps.train=NA,crps.cv=NA)
cv.crps <- matrix(ncol=5,nrow=8)
for(i in 1:8){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
weighted.df <- ((t(t(df[,4:21])*weights[,i]))) 
weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,18)) 
mos <- fitMOS(weighted.ED, model= model)
model.df[i,2]<-mos$a
model.df[i,3]<-mos$B[1]
model.df[i,4]<-mos$c
model.df[i,5]<-mos$d
model.df[i,6]<-colMeans(ensembleMOS::crps(mos, na.omit(weighted.ED)))[1]
model.df[i,7]<-colMeans(ensembleMOS::crps(mos, na.omit(weighted.ED)))[2]

for(j in 1:5){
cv.index <- matrix(data=c(1:7785),ncol=5)
mos <- fitMOS(weighted.ED[-c(cv.index[,j]),], model = model)
cv.crps[i,j]<-colMeans(ensembleMOS::crps(mos, na.omit(weighted.ED[c(cv.index[,j]),])))[2]}
  model.df[i,8]<-mean(cv.crps[i,])
}
return(model.df)}

w5 <- seq(1,0,by=-1/6)[1:6]
w5.1<-c((w5/sum(w5)))*6
repw.5 <- rep(w5.1,each=3)
weights.lin.noCon <- data.frame(repw.5,repw.5,repw.5,repw.5,repw.5,repw.5,repw.5,repw.5)

model4.5.df <- model4.5.function("truncnormal", weights.lin.noCon)
```

###   Verification: CRPS

```{r}
par(mfrow=c(4,2))
cp.test.mod4.5 <- rep(NA,8)
for(i in 1:8){
df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i])) 
weighted.df <- ((t(t(df[,4:21])*weights.lin.noCon[,i]))) 
weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,18))
for(j in 1:5){
mos <- fitMOS(weighted.ED[-c(cv.index[,j]),], model = 'truncnormal')
assign(paste0('fold',j),pars(mos, weighted.ED[c(cv.index[,j]),])) } 
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- na.omit(data.frame(na.omit(weighted.ED$observations),folds))
cp.test.mod4.5[i] <- verification::crps(df.crps[,1], df.crps[,2:3])$CRPS 
hist(ptnorm(df.crps[,1],df.crps[,2],df.crps[,3],left=0),main= paste0("PIT histogram,  lead ",seq(6,48,by=6)[i]), xlab = "Probability", ylab="Frequency")}

model4.5.df$crps.totalcv <-cp.test.mod4.5
model4.5.df[,c(1,6:9)]

```

###   Brier Skill Score

```{r}
bs.train.4.5<-function(model){
bs <- data.frame(thresholds = seq(2,24,by=2))
thresholds <- seq(2,24,by=2)
coast.index.mat = rep(coast.index,173)
brier.land<-matrix(nrow=8,ncol=12)
brier.coast=matrix(nrow=8,ncol=12)

for(i in 1:8){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
  cv.index <- matrix(data=c(1:7785),ncol=5)
 weighted.df <- ((t(t(df[,4:21])*weights.lin.noCon[,i]))) 
 weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,18)) 
df.train <- weighted.ED 
df.train$coast = coast.index.mat
coast.index = na.omit(df.train)$coast
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = model)
assign(paste0('fold',j),cdf(mos, df.train[c(cv.index[,j]),],thresholds)) }
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- (data.frame((df.train$observations),folds))
for(j in 1:12){
brier.coast[i,j] = brier(obs=ifelse(df.crps[coast.index==1,1] <thresholds[j],1,0), df.crps[coast.index==1,j+1],bins=F)$ss
brier.land[i,j] = brier(obs=ifelse(df.crps[coast.index==0,1] <thresholds[j],1,0), df.crps[coast.index==0,j+1],bins=F)$ss}
}
bss.test<-list(brier.coast,brier.land)
return(bss.test)}

w5 <- seq(1,0,by=-1/6)[1:6]
w5.1<-c((w5/sum(w5)))*6
repw.5 <- rep(w5.1,each=3)
weights.lin.noCon <- data.frame(repw.5,repw.5,repw.5,repw.5,repw.5,repw.5,repw.5,repw.5)

bss.train.mod4.5 <- bs.train.4.5("truncnormal")
bss.train.mod7.5 <- bs.train.4.5("lognormal")

```


##   Model 4.6	Weights based on correlations 
```{r}
rho <- matrix(nrow=7,ncol=8)

for ( i in 1:8){
   df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
   df.comb <-data.frame(control=df$control, mini.ens1=rowMeans(df[,4:6]), 
                            mini.ens2=rowMeans(df[,7:9]), mini.ens3=rowMeans(df[,10:12]),
                            mini.ens4=rowMeans(df[,13:15]), mini.ens5=rowMeans(df[,16:18]),
                            mini.ens6=rowMeans(df[,19:21])) 
for ( j in 1:7){
  rho[j,i]= cor((df.comb[-c(which(is.na(df$observation)),which(is.na(df.comb[,j]))),j]),
                df$observation[-c(which(is.na(df$observation)),which(is.na(df.comb[,j])))])
}}
rownames(rho)<-paste0(" member",c(0:6))
colnames(rho)<- paste0(" lead" , seq(6,48,by=6))
rho <- (t(t(rho)/colSums(rho)))*7
rho.df <- rho[rep(seq_len(nrow(rho[,])), each = 3), ]
rho.df <- rho.df[-c(1,2),]  

model4.3.function<-function(model){
  model4.3.df <- data.frame(lead=seq(6,48,by=6),intercept=NA,coefB=NA,coefC=NA,coefD=NA,crps.raw=NA, crps.train=NA,crps.cv=NA)
cv.crps4.3 <- matrix(ncol=5,nrow=8)
for(i in 1:8){
df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
weighted.df <- ((t(t(df[,3:21])*rho.df[,i]))) 
weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19)) 
mos4.3 <- fitMOS(weighted.ED, model= model)
model4.3.df[i,2]<-mos4.3$a
model4.3.df[i,3]<-mos4.3$B[1]
model4.3.df[i,4]<-mos4.3$c
model4.3.df[i,5]<-mos4.3$d
model4.3.df[i,6]<-colMeans(ensembleMOS::crps(mos4.3, na.omit(weighted.ED)))[1]
model4.3.df[i,7]<-colMeans(ensembleMOS::crps(mos4.3, na.omit(weighted.ED)))[2]
for(j in 1:5){
cv.index <- matrix(data=c(1:7785),ncol=5)
mos4.3 <- fitMOS(weighted.ED[-c(cv.index[,j]),], model = model)
cv.crps4.3[i,j]<-colMeans(ensembleMOS::crps(mos4.3, na.omit(weighted.ED[c(cv.index[,j]),])))[2]}
  model4.3.df[i,8]<-mean(cv.crps4.3[i,])
}
return(model4.3.df)}

model4.6.df <- model4.3.function("truncnormal")
```

###    Verification: CRPS cv 
```{r}
par(mfrow=c(4,2))
cp.test.mod4.6 <- rep(NA,8)
for(i in 1:8){
df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i])) 

weighted.df <- ((t(t(df[,3:21])*rho.df[,i]))) 
weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19))
for(j in 1:5){
mos <- fitMOS(weighted.ED[-c(cv.index[,j]),], model = 'truncnormal')
assign(paste0('fold',j),pars(mos, weighted.ED[c(cv.index[,j]),])) } 
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- na.omit(data.frame(na.omit(weighted.ED$observations),folds))
cp.test.mod4.6[i] <- verification::crps(df.crps[,1], df.crps[,2:3])$CRPS 
hist(ptnorm(df.crps[,1],df.crps[,2],df.crps[,3],left=0),main= paste0("PIT histogram,  lead ",seq(6,48,by=6)[i]), xlab = "Probability", ylab="Frequency")}

model4.6.df$crps.totalcv <-cp.test.mod4.6
model4.6.df[,c(1,6:9)]

```

###   Brier Skill Score

```{r}
bss.train.mod4.6 <- bs.train.4("truncnormal",rho.df)
bss.train.mod7.6 <- bs.train.4("lognormal",rho.df)


bs4.6 <- data.frame(thresholds = seq(2,24,by=2))
thresholds <- seq(2,24,by=2)
for(i in 1:8){

df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
weighted.df <- ((t(t(df[,3:21])*rho.df[,i]))) 
weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19)) 
df.train <- weighted.ED 
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = 'truncnormal')
assign(paste0('fold',j),cdf(mos, df.train[c(cv.index[,j]),],thresholds)) }
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- (data.frame((df.train$observations),folds))
for(j in 1:12){
bs4.6[j,paste0("BS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$bs
bs4.6[j,paste0("SS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$ss} }

par(mfrow=c(4,3))
for (j in 1:12){
  plot(y=as.numeric(bs4.6[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Model 4.6: Brier Score, threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Score")}
```


```{r}
par(mfrow=c(4,3))
for (j in 1:11){
  plot(y=as.numeric(bs4.6[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Model 4.6: Brier Skill Score,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Skill Score")
  abline(h=0)}
```

##    Bootstrap CRPS Weight models 
```{r}
bootmean <- function(scores, nsamples=250){
  boot <- NULL
  for(i in 1:nsamples){
    bindex=sample(length(scores), replace=T)
    boot<-rbind(boot, mean(scores[bindex]))
  }
  boot
}

bootstrap.function<-function(model,weights){
  crps.mod<-NULL
for (j in 1:8){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
weighted.df <- ((t(t(df[,3:21])*weights[,i]))) 
weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19)) 
for(j in 1:5){
mos <- fitMOS(weighted.ED[-c(cv.index[,j]),], model = model)
assign(paste0('fold',j),pars(mos, weighted.ED[c(cv.index[,j]),])) } 
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- na.omit(data.frame(na.omit(weighted.ED$observations),folds))
scores <- bootmean(verification::crps(df.crps[,1], df.crps[,2:3])$crps)
crps.mod <- cbind(crps.mod,scores)}
colnames(crps.mod) <- paste0(seq(6,48,by=6))
return(crps.mod)}

bs.mod4.5 <- function(model,weights){
  crps.mod<-NULL
for(i in 1:8){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
weighted.df <- ((t(t(df[,4:21])*weights[,i]))) 
weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,18)) 
for(j in 1:5){
mos <- fitMOS(weighted.ED[-c(cv.index[,j]),], model = model)
assign(paste0('fold',j),pars(mos, weighted.ED[c(cv.index[,j]),])) } 
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- na.omit(data.frame(na.omit(weighted.ED$observations),folds))
scores <- bootmean(verification::crps(df.crps[,1], df.crps[,2:3])$crps)
crps.mod <- cbind(crps.mod,scores)}
colnames(crps.mod) <- paste0(seq(6,48,by=6))
return(crps.mod)}

crps.bs.mod4 <- cbind(bootstrap.function("truncnormal", weights.rmse.df),bootstrap.function("truncnormal", weights.mse.df),
bootstrap.function("truncnormal", weights.lin),bootstrap.function("truncnormal", weights.lin.rmse.df),bs.mod4.5("truncnormal",weights.lin.noCon),bootstrap.function("truncnormal",rho.df),bootstrap.function("truncnormal", weights.lin7))


par(mfrow=c(4,2))
for (i in 1:8){
  index <- matrix(1:56,nrow=8)
  boxplot(crps.bs.mod4[,c(index[i,])],ylab="CRPS",xlab= "Model",main=c(paste0("Lead time ", seq(6,48,by=6)[i])),names=c(paste0("Model4.",seq(1,7)))) 
}
```

```{r}
bootstrap.functionln<-function(model,weights){
  crps.mod<-NULL
for (j in 1:8){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
weighted.df <- ((t(t(df[,3:21])*weights[,i]))) 
weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19)) 
for(j in 1:5){
mos <- fitMOS(weighted.ED[-c(cv.index[,j]),], model = model)
assign(paste0('fold',j),pars(mos, weighted.ED[c(cv.index[,j]),])) } 
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- na.omit(data.frame(na.omit(weighted.ED$observations),folds))
scores <- bootmean(verification::crps(df.crps[,1], exp(df.crps[,2:3]))$crps)
crps.mod <- cbind(crps.mod,scores)}
colnames(crps.mod) <- paste0(seq(6,48,by=6))
return(crps.mod)}

bs.mod4.5ln <- function(model,weights){
  crps.mod<-NULL
for(i in 1:8){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
weighted.df <- ((t(t(df[,4:21])*weights[,i]))) 
weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,18)) 
for(j in 1:5){
mos <- fitMOS(weighted.ED[-c(cv.index[,j]),], model = model)
assign(paste0('fold',j),pars(mos, weighted.ED[c(cv.index[,j]),])) } 
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- na.omit(data.frame(na.omit(weighted.ED$observations),folds))
scores <- bootmean(verification::crps(df.crps[,1], exp(df.crps[,2:3]))$crps)
crps.mod <- cbind(crps.mod,scores)}
colnames(crps.mod) <- paste0(seq(6,48,by=6))
return(crps.mod)}

crps.bs.mod7 <- cbind(bootstrap.functionln("lognormal", weights.rmse.df),bootstrap.functionln("lognormal", weights.mse.df),
bootstrap.functionln("lognormal", weights.lin),bootstrap.functionln("lognormal", weights.lin.rmse.df),bs.mod4.5ln("lognormal",weights.lin.noCon),bootstrap.functionln("lognormal",rho.df))

par(mfrow=c(4,2))
for (i in 1:8){
  index <- matrix(1:48,nrow=8)
  boxplot(crps.bs.mod7[,c(index[i,])],ylab="CRPS",xlab= "Model",main=c(paste0("Lead time ", seq(6,48,by=6)[i])),names=c(paste0("Model7.",seq(1,6)))) 
}

```
save all weights 
```{r}
save(weights.mse.df, weights.rmse.df,weights.lin,weights.lin.rmse.df,weights.lin.noCon, file="weights_weightmodels.RData")
```


##    Plot CV weight 4.1-4.6

```{r}

crps.weight <-
  data.frame(lead= seq(6,48,by=6),
         model2.tn.cv=model2.df$crps.cv,
        model3.tn.cv=model3.df$crps.cv,    
        model4.1.tn.cv=model4.1.df$crps.cv,
        model4.2.tn.cv=model4.2.df$crps.cv,
        model4.3.tn.cv=model4.3.df$crps.cv,
        model4.4.tn.cv=model4.4.df$crps.cv,
        model4.5.tn.cv = model4.5.df$crps.cv,
        model4.6.tn.cv=model4.6.df$crps.cv)


dftest <- melt(crps.weight,  id.vars = 'lead', variable.name = 'model')
ggplot(dftest, aes(lead,value))+geom_line(aes(colour=model))
```


#   Log-normal:

#   Model 5: LN Exchangeable ensemble members

```{r}
model5.df <- model2.function("lognormal")
```

##    Verification 

###   Total CV: 
```{r,fig.width=12, fig.height=4}
par(mfrow=c(2,4))
#crps.total <-function(df){
c.test<-rep(NA,8)
for(i in 1:8){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i])) 

df.train<-ensembleData(forecasts=df[,3:21],dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19))
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = 'lognormal')
assign(paste0('fold',j),pars(mos, df.train[c(cv.index[,j]),])) }
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- na.omit(data.frame(na.omit(df.train$observations),folds))
c.test[i] <- verification::crps(df.crps[,1], exp(df.crps[,2:3]))$CRPS 
hist(plnorm(df.crps[,1],df.crps[,2],df.crps[,3]),main= paste0("Lead time ",sprintf("%02d",seq(6,48,by=6))[i],"h"), xlab = "Probability", ylab="Frequency",breaks=15)}

```

###   CRPS (by cross-validation)
```{r}
model5.df$crps.cv.total <- c.test
model5.df[,c(1,6,7,8,9)]

```

###   Bootstrapped CRPS
```{r}
scores.mod5 <- bootstrap.crps2("lognormal")
boxplot(scores.mod5,ylab="CRPS",xlab= "Lead", main="Bootstrapped CRPS model 5") #for each test model
```


###   Brier Skill Score
```{r}
bs5 <- data.frame(thresholds = seq(2,24,by=2))
thresholds <- seq(2,24,by=2)
for(i in 1:8){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))

  df.train <- ensembleData(forecasts=df[,3:21],dates=df$date,
                           observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                           initializationTime = "00", exchangeable = rep(1,19))
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = 'lognormal')
assign(paste0('fold',j),cdf(mos, df.train[c(cv.index[,j]),],thresholds)) }
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- (data.frame((df.train$observations),folds))

for(j in 1:12){
bs5[j,paste0("BS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$bs
bs5[j,paste0("SS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$ss} }

par(mfrow=c(4,3))
for (j in 1:10){
  plot(y=as.numeric(bs5[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Skill Score,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Skill Score")
  abline(h=0)}
```


###   Reliability plot
```{r, fig.size=3,fig.width=3}
thresholds <- seq(2,24,by=2)
rel.plot5 <-function(k){
for(i in 1:8){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
  cv.index <- matrix(data=c(1:7785),ncol=5)
  df.train <- ensembleData(forecasts=df[,3:21],dates=df$date,
                           observations=df$observation, forecastHour = seq(6,48,by=6)[i], initializationTime = "00", exchangeable = rep(1,19))
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = 'lognormal')
assign(paste0('fold',j),cdf(mos, df.train[c(cv.index[,j]),],thresholds)) }

folds <- rbind(fold1,fold2,fold3,fold4,fold5)

p <- ifelse(((1 - folds[,k]) <0),0,1- (folds[,k]))
ReliabilityDiagram(p, (df.train$observation > thresholds[k]), plot=TRUE, handle.na="use.pairwise.complete")}
}

rel.plot5(k=7) #threshold 14
rel.plot5(k=8) #threhsold 16
rel.plot5(k=9) #threshold 18

```

#   Model 6: Separate mini-ensembles

```{r}
model6.df <- model3.function("lognormal")
```

##    Verification 

###   CRPS (by cross-validation)
```{r}
par(mfrow=c(4,2))
cp.test.mod6 <- rep(NA,8)
for(i in 1:8){
df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i])) 
cv.index <-  matrix(data=c(1:7785),ncol=5)
df.train <- ensembleData(forecasts=df[3:21],dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = c(1,rep(2:7,each=3)))
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = 'lognormal')
assign(paste0('fold',j),pars(mos, df.train[c(cv.index[,j]),])) }
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- na.omit(data.frame(na.omit(df.train$observations),folds))
cp.test.mod6[i] <- verification::crps(df.crps[,1], exp(df.crps[,2:3]))$CRPS 
hist(plnorm(df.crps[,1],df.crps[,2],df.crps[,3]),main= paste0("PIT histgram,  lead ",seq(6,48,by=6)[i]), xlab = "Probability", ylab="Frequency")}

model6.df$crps.totalcv <-cp.test.mod6
model6.df[,c(1,12:15)]

```

###   Brier Skill Score
```{r}
bs6 <- data.frame(thresholds = seq(2,24,by=2))
thresholds <- seq(2,24,by=2)
for(i in 1:8){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
  df.train <- ensembleData(forecasts=df[3:21],dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = c(1,rep(2:7,each=3)))
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = 'lognormal')
assign(paste0('fold',j),cdf(mos, df.train[c(cv.index[,j]),],thresholds)) }
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- (data.frame((df.train$observations),folds))

for(j in 1:12){
bs6[j,paste0("BS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$bs
bs6[j,paste0("SS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$ss} }

par(mfrow=c(4,3))
for (j in 1:11){
  plot(y=as.numeric(bs6[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Model 6: Brier Skill Score,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Skill Score")
  abline(h=0)}
```

```{r}
par(mfrow=c(4,3))
for (j in 1:12){
  plot(y=as.numeric(bs6[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Model 6: Brier Score, threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Score")}

```

###   Reliability Diagram
```{r fig.height = 3, fig.width = 3}
rel.plot6 <-function(k){
for(i in 1:8){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
  df.train <- ensembleData(forecasts=df[3:21],dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = c(1,rep(2:7,each=3)))
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = 'lognormal')
assign(paste0('fold',j),cdf(mos, df.train[c(cv.index[,j]),],thresholds)) }
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
p <- ifelse(((1 - folds[,k]) <0),0,1- (folds[,k]))
ReliabilityDiagram(p, (df.train$observation > thresholds[k]), plot=TRUE, handle.na="use.pairwise.complete")}
}

rel.plot6(k=7)
rel.plot6(k=8)
rel.plot6(k=9)
```

#   Model 7: Weighted Ensemble Average Models

##    Model 7.1 LN    
```{r}
model7.1.df <- model4.1.function("lognormal", weights.rmse.df)
```

###   Verification: CRPS cv 
```{r}
par(mfrow=c(3,3))
cp.test.mod7.1 <- rep(NA,8)
for(i in 1:8){
df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i])) 

weighted.df <- ((t(t(df[,3:21])*weights.rmse.df[,i]))) 
weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19)) 

for(j in 1:5){
mos <- fitMOS(weighted.ED[-c(cv.index[,j]),], model = 'lognormal')
assign(paste0('fold',j),pars(mos, weighted.ED[c(cv.index[,j]),])) } 

folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- na.omit(data.frame(na.omit(weighted.ED$observations),folds))
cp.test.mod7.1[i] <- verification::crps(df.crps[,1], exp(df.crps[,2:3]))$CRPS 
hist(plnorm(df.crps[,1],df.crps[,2],df.crps[,3]),main= paste0("PIT histgram,  lead ",seq(6,48,by=6)[i]), xlab = "Probability", ylab="Frequency")}

model7.1.df$crps.totalcv <-cp.test.mod7.1
model7.1.df[,c(1,7,8,9)]
```




Check: now we add the normal data frame, do we want this or do we need the weighted df?
```{r,include=F}
par(mfrow=c(4,2))
for (j in 1:8){
  df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[j]))
  weighted.df <- ((t(t(df[,3:21])*weights.rmse.df[,i])))
m <-model7.1.df$intercept[j]+ (model7.1.df$coefB[j]*19*apply(weighted.df,1,mean))
v <-model7.1.df$coefC[j]+model7.1.df$coefD[j]*(apply(weighted.df,1,var))
mu <- log(m^2/sqrt(v+(m^2)))
sig <- log(1+v/(m^2))
hist(plnorm(df$observation,mu,sqrt(sig)),main= paste0("PIT histgram,  lead ",seq(6,48,by=6)[j]), xlab = "Probability", ylab="Frequency")}
```

###   Brier Skill Score

```{r}
par(mfrow=c(4,2))
bs7.1 <- data.frame(thresholds = seq(2,24,by=2))
thresholds <- seq(2,24,by=2)
for(i in 1:8){
df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
weighted.df <- ((t(t(df[,3:21])*weights.rmse.df[,i]))) 
weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19)) 
df.train <- weighted.ED 
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = 'lognormal')
assign(paste0('fold',j),cdf(mos, df.train[c(cv.index[,j]),],thresholds)) }
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- (data.frame((df.train$observations),folds))
for(j in 1:12){
bs7.1[j,paste0("BS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$bs
bs7.1[j,paste0("SS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$ss} }


par(mfrow=c(4,3))
for (j in 1:11){
  plot(y=as.numeric(bs7.1[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Skill Score,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Skill Score")
  abline(h=0)}
```


```{r}
par(mfrow=c(4,3))
for (j in 1:12){
  plot(y=as.numeric(bs7.1[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Score, threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Score")}

```

##   Model 7.2 LN Weights based on MSE
```{r}
model7.2.df <- model4.1.function("lognormal", weights.mse.df)

par(mfrow=c(4,2))
cp.test.mod7.2 <- rep(NA,8)
for(i in 1:8){
df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i])) 

weighted.df <- ((t(t(df[,3:21])*weights.mse.df[,i]))) 
weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19)) 

for(j in 1:5){
mos <- fitMOS(weighted.ED[-c(cv.index[,j]),], model = 'lognormal')
assign(paste0('fold',j),pars(mos, weighted.ED[c(cv.index[,j]),])) } 

folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- na.omit(data.frame(na.omit(weighted.ED$observations),folds))
cp.test.mod7.2[i] <- verification::crps(df.crps[,1], exp(df.crps[,2:3]))$CRPS 
hist(plnorm(df.crps[,1],df.crps[,2],df.crps[,3]),main= paste0("PIT histgram,  lead ",seq(6,48,by=6)[i]), xlab = "Probability", ylab="Frequency")}

model7.2.df$crps.totalcv <-cp.test.mod7.2
model7.2.df[,c(1,7,8,9)]
```

###   Verification: CRPS cv 
```{r}
model7.2.df[,c(1,6:8)]
```

###   Brier Skill Score

```{r}
par(mfrow=c(4,2))
bs7.2 <- data.frame(thresholds = seq(2,24,by=2))
thresholds <- seq(2,24,by=2)
for(i in 1:8){
df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
weighted.df <- ((t(t(df[,3:21])*weights.mse.df[,i]))) 

weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19)) 
df.train <- weighted.ED 
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = 'lognormal')
assign(paste0('fold',j),cdf(mos, df.train[c(cv.index[,j]),],thresholds)) }
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- (data.frame((df.train$observations),folds))
for(j in 1:12){
bs7.2[j,paste0("BS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$bs
bs7.2[j,paste0("SS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$ss} }

par(mfrow=c(4,3))
for (j in 1:12){
  plot(y=as.numeric(bs7.2[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Model 7.2: Brier Score, threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Score")}
```


```{r}
par(mfrow=c(4,3))
for (j in 1:11){
  plot(y=as.numeric(bs7.2[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Model 7.2: Brier Skill Score,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Skill Score")
  abline(h=0)}

```

##    Model 7.3 LN Weights based on age (linear decreasing)
```{r}
model7.3.df <- model4.1.function("lognormal", weights.lin)
```

###   Verification: CRPS cv 
```{r}
par(mfrow=c(4,2))
cp.test.mod7.3 <- rep(NA,8)
for(i in 1:8){
df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i])) 
cv.index <-  matrix(data=c(1:7785),ncol=5)
weighted.df <- ((t(t(df[,3:21])*weights.lin[,i]))) 
weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19)) 

for(j in 1:5){
mos <- fitMOS(weighted.ED[-c(cv.index[,j]),], model = 'lognormal')
assign(paste0('fold',j),pars(mos, weighted.ED[c(cv.index[,j]),])) } 

folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- na.omit(data.frame(na.omit(weighted.ED$observations),folds))
cp.test.mod7.3[i] <- verification::crps(df.crps[,1],exp(df.crps[,2:3]))$CRPS 
hist(plnorm(df.crps[,1],df.crps[,2],df.crps[,3]),main= paste0("PIT histogram,  lead ",seq(6,48,by=6)[i]), xlab = "Probability", ylab="Frequency")}

model7.3.df$crps.totalcv <-cp.test.mod7.3

model7.3.df[,c(1,6:9)]

model7.3.df[,c(1,6:8)]
```


###   Brier Skill Score

```{r}
par(mfrow=c(4,2))
bs7.3 <- data.frame(thresholds = seq(2,24,by=2))
thresholds <- seq(2,24,by=2)

for(i in 1:8){
df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
weighted.df <- ((t(t(df[,3:21])*weights.lin[,i]))) 

weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19)) 
df.train <- weighted.ED 
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = 'lognormal')
assign(paste0('fold',j),cdf(mos, df.train[c(cv.index[,j]),],thresholds)) }
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- (data.frame((df.train$observations),folds))
for(j in 1:12){
bs7.3[j,paste0("BS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$bs
bs7.3[j,paste0("SS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$ss} }

par(mfrow=c(4,3))
for (j in 1:12){
  plot(y=as.numeric(bs7.3[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Model 7.3: Brier Score, threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Score")}
```

```{r}
par(mfrow=c(4,3))
for (j in 1:11){
  plot(y=as.numeric(bs7.3[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Model 7.3: Brier Skill Score,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Skill Score")
  abline(h=0)}

```

##   Model 7.4 Log-normal Weights based on rank RMSE, linear decreasing 
```{r}
model7.4.df <- model4.1.function(model="lognormal", weights.lin.rmse.df)
```

###    Verification: CRPS cv 
```{r}
  par(mfrow=c(4,2))
cp.test.mod7.4 <- rep(NA,8)
for(i in 1:8){
df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i])) 
weighted.df <- ((t(t(df[,3:21])*weights.lin.rmse.df[,i]))) 
weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19))
for(j in 1:5){
mos <- fitMOS(weighted.ED[-c(cv.index[,j]),], model = 'lognormal')
assign(paste0('fold',j),pars(mos, weighted.ED[c(cv.index[,j]),])) } 
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- na.omit(data.frame(na.omit(weighted.ED$observations),folds))
cp.test.mod7.4[i] <- verification::crps(df.crps[,1], exp(df.crps[,2:3]))$CRPS 
hist(plnorm(df.crps[,1],df.crps[,2],df.crps[,3]),main= paste0("PIT histogram,  lead ",seq(6,48,by=6)[i]), xlab = "Probability", ylab="Frequency")}

model7.4.df$crps.totalcv <-cp.test.mod7.4
model7.4.df[,c(1,6:9)]

```

###   Brier Skill Score

```{r}
bs7.4 <- data.frame(thresholds = seq(2,24,by=2))
thresholds <- seq(2,24,by=2)

for(i in 1:8){
df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
weighted.df <- ((t(t(df[,3:21])*weights.lin.rmse.df[,i]))) 
weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19)) 
df.train <- weighted.ED 
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = 'lognormal')
assign(paste0('fold',j),cdf(mos, df.train[c(cv.index[,j]),],thresholds)) }
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- (data.frame((df.train$observations),folds))
for(j in 1:12){
bs7.4[j,paste0("BS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$bs
bs7.4[j,paste0("SS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$ss} }

par(mfrow=c(4,3))
for (j in 1:12){
  plot(y=as.numeric(bs7.4[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Model 7.4: Brier Score, threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Score")}
```


```{r}
par(mfrow=c(4,3))
for (j in 1:11){
  plot(y=as.numeric(bs7.4[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Model 7.4: Brier Skill Score,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Skill Score")
  abline(h=0)}

```

###   Model 7.5 Weights based on age, without control as predictor
```{r}
model7.5.df <- model4.5.function("lognormal", weights.lin.noCon)

```

###   Verification: CRPS

```{r}
par(mfrow=c(4,2))
cp.test.mod7.5 <- rep(NA,8)
for(i in 1:8){
df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i])) 

weighted.df <- ((t(t(df[,4:21])*weights.lin.noCon[,i]))) 
weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,18))
for(j in 1:5){
mos <- fitMOS(weighted.ED[-c(cv.index[,j]),], model = 'lognormal')
assign(paste0('fold',j),pars(mos, weighted.ED[c(cv.index[,j]),])) } 
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- na.omit(data.frame(na.omit(weighted.ED$observations),folds))
cp.test.mod7.5[i] <- verification::crps(df.crps[,1], exp(df.crps[,2:3]))$CRPS 
hist(plnorm(df.crps[,1],df.crps[,2],df.crps[,3]),main= paste0("PIT histogram,  lead ",seq(6,48,by=6)[i]), xlab = "Probability", ylab="Frequency")}

model7.5.df$crps.totalcv <-cp.test.mod7.5
model7.5.df[,c(1,6:9)]

```



###   Brier Skill Score

```{r}
bs7.5 <- data.frame(thresholds = seq(2,24,by=2))
thresholds <- seq(2,24,by=2)
for(i in 1:8){
df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
weighted.df <- ((t(t(df[,4:21])*weights.lin.noCon[,i]))) 

weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,18)) 
df.train <- weighted.ED 
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = 'lognormal')
assign(paste0('fold',j),cdf(mos, df.train[c(cv.index[,j]),],thresholds)) }
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- (data.frame((df.train$observations),folds))
for(j in 1:12){
bs7.5[j,paste0("BS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$bs
bs7.5[j,paste0("SS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$ss} }

par(mfrow=c(4,3))
for (j in 1:12){
  plot(y=as.numeric(bs7.5[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Model 7.5: Brier Score, threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Score")}
```


```{r}
par(mfrow=c(4,3))
for (j in 1:11){
  plot(y=as.numeric(bs7.5[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Model 7.5: Brier Skill Score,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Skill Score")
  abline(h=0)}

```



##     Model 7.6 LN : weights based on correlation with observations
```{r}
model7.6.df <- model4.3.function("lognormal")
```

###    Verification: CRPS cv 
```{r}
par(mfrow=c(4,2))
cp.test.mod7.6 <- rep(NA,8)
for(i in 1:8){
df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i])) 

weighted.df <- ((t(t(df[,3:21])*rho.df[,i]))) 
weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19))
for(j in 1:5){
mos <- fitMOS(weighted.ED[-c(cv.index[,j]),], model = 'lognormal')
assign(paste0('fold',j),pars(mos, weighted.ED[c(cv.index[,j]),])) } 
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- na.omit(data.frame(na.omit(weighted.ED$observations),folds))
cp.test.mod7.6[i] <- verification::crps(df.crps[,1], exp(df.crps[,2:3]))$CRPS 
hist(plnorm(df.crps[,1],df.crps[,2],df.crps[,3]),main= paste0("PIT histogram,  lead ",seq(6,48,by=6)[i]), xlab = "Probability", ylab="Frequency")}

model7.6.df$crps.totalcv <-cp.test.mod7.6
model7.6.df[,c(1,6:9)]

```


###   Brier Skill Score

```{r}
bs7.6 <- data.frame(thresholds = seq(2,24,by=2))
thresholds <- seq(2,24,by=2)
for(i in 1:8){
df<- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
weighted.df <- ((t(t(df[,3:21])*rho.df[,i]))) 
weighted.ED<- ensembleData(forecasts= weighted.df,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,19)) 
df.train <- weighted.ED 
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = 'lognormal')
assign(paste0('fold',j),cdf(mos, df.train[c(cv.index[,j]),],thresholds)) }
folds <- rbind(fold1,fold2,fold3,fold4,fold5)
df.crps <- (data.frame((df.train$observations),folds))
for(j in 1:12){
bs7.6[j,paste0("BS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$bs
bs7.6[j,paste0("SS, lead",seq(6,48,by=6)[i])] <- brier(obs=ifelse(df.crps[,1] <thresholds[j],1,0), df.crps[,j+1],bins=F)$ss} }

par(mfrow=c(4,3))
for (j in 1:12){
  plot(y=as.numeric(bs7.6[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Model 7.6: Brier Score, threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Score")}
```

```{r}
par(mfrow=c(4,3))
for (j in 1:11){
  plot(y=as.numeric(bs7.6[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Model 7.6: Brier Skill Score,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Skill Score")
  abline(h=0)}

```


##    Plot CV weight 7.1-7.6

```{r}
crps.weight <-
  data.frame(lead= seq(6,48,by=6),
         model5.tn.cv=model2.df$crps.cv,
        model6.tn.cv=model3.df$crps.cv,    
        model7.1.tn.cv=model7.1.df$crps.cv,
        model7.2.tn.cv=model7.2.df$crps.cv,
        model7.3.tn.cv=model7.3.df$crps.cv,
        model7.7.tn.cv=model7.7.df$crps.cv,
        model7.5.tn.cv = model7.5.df$crps.cv,
        model7.6.tn.cv=model7.6.df$crps.cv)
crps.weight <-
  data.frame(lead= seq(6,48,by=6),
         model2.tn.cv=model2.df$crps.cv,
        model3.tn.cv=model3.df$crps.cv,    
        model4.1.tn.cv=model4.1.df$crps.cv,
        model4.2.tn.cv=model4.2.df$crps.cv,
        model4.3.tn.cv=model4.3.df$crps.cv,
        model4.4.tn.cv=model4.4.df$crps.cv,
        model4.5.tn.cv = model4.5.df$crps.cv,
        model4.6.tn.cv=model4.6.df$crps.cv)


dftest <- melt(crps.weight,  id.vars = 'lead', variable.name = 'model')
ggplot(dftest, aes(lead,value))+geom_line(aes(colour=model))
```


##   Model 8/10: only control as predictor 3x3 / 5x5 

```{r}

model8.function<-function(model){
model.df <- data.frame(lead=seq(6,48,by=6),intercept=NA,coefB=NA,coefC=NA,coefD=NA, crps.raw=NA, crps.train=NA,crps.cv=NA)
cv.crps<-matrix(ncol=5,nrow=8)
for(i in 1:8){
  df.control<- get(paste0("wide.control." ,sprintf("%02d",seq(6,48,by=6))[i],"h"))
  df <- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
  df.train <- ensembleData(forecasts=df.control[,1:9],dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,9))
mos <- fitMOS(df.train, model = model)
model.df[i,2]<-mos$a
model.df[i,3]<-mos$B[1]
model.df[i,4]<-mos$c
model.df[i,5]<-mos$d
model.df[i,6]<-colMeans(ensembleMOS::crps(mos, na.omit(df.train)))[1]
model.df[i,7]<-colMeans(ensembleMOS::crps(mos, na.omit(df.train)))[2]

for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = model)
cv.crps[i,j]<-colMeans(ensembleMOS::crps(mos, na.omit(df.train[c(cv.index[,j]),])))[2]}

  model.df[i,8]<-mean(cv.crps[i,])}
return(model.df)}

model8.df <- model8.function("truncnormal")
model9.df <- model8.function("lognormal")

```

```{r}
model10.function<-function(model){
model.df <- data.frame(lead=seq(6,48,by=6),intercept=NA,coefB=NA,coefC=NA,coefD=NA, crps.raw=NA, crps.train=NA,crps.cv=NA)
cv.crps<-matrix(ncol=5,nrow=8)
for(i in 1:8){
  df.control<- get(paste0("control.5x5." ,sprintf("%02d",seq(6,48,by=6))[i],"h"))
  df <- get(paste0("long",sprintf("%02d",seq(6,48,by=6))[i]))
  df.train <- ensembleData(forecasts=df.control,dates=df$date,
                               observations=df$observation, forecastHour = seq(6,48,by=6)[i],
                               initializationTime = "00", exchangeable = rep(1,25))
mos <- fitMOS(df.train, model = model)
model.df[i,2]<-mos$a
model.df[i,3]<-mos$B[1]
model.df[i,4]<-mos$c
model.df[i,5]<-mos$d
model.df[i,6]<-colMeans(ensembleMOS::crps(mos, na.omit(df.train)))[1]
model.df[i,7]<-colMeans(ensembleMOS::crps(mos, na.omit(df.train)))[2]
cv.index <- matrix(data=c(1:7785),ncol=5)
for(j in 1:5){
mos <- fitMOS(df.train[-c(cv.index[,j]),], model = model)
cv.crps[i,j]<-colMeans(ensembleMOS::crps(mos, na.omit(df.train[c(cv.index[,j]),])))[2]}
model.df[i,8]<-mean(cv.crps[i,])}
return(model.df)}


model10.df <- model10.function("truncnormal")
model11.df <- model10.function("lognormal")
```

##     CRPS plots


```{r}
control.mod <- data.frame(lead=seq(6,48,by=6),
                          model8 = model8.df$crps.cv,
                           model9 = model9.df$crps.cv,
                          model10 = model10.df$crps.cv,
                          model11 = model11.df$crps.cv,
                          raw= model11.df$crps.raw)
control.mod2 <- melt(control.mod,  id.vars = 'lead', variable.name = 'model')
ggplot(control.mod2, aes(lead,value))+geom_line(aes(colour=model))

```



#   PLOTS! 

```{r}
crps.all.cv <-
  data.frame(lead= seq(6,48,by=6),
        raw= model2.df$raw,
        model2.tn.cv=model2.df$crps.cv,
        model3.tn.cv=model3.df$crps.cv,
        model4.1.tn.cv=model4.1.df$crps.cv,
        model4.2.tn.cv=model4.2.df$crps.cv,
        model4.3.tn.cv=model4.3.df$crps.cv,
        model4.4.tn.cv=model4.4.df$crps.cv,
        model4.5.tn.cv = model4.5.df$crps.cv,
        model4.6.tn.cv = model4.6.df$crps.cv,
        model8.tn = model8.df$crps.cv,
        model5.ln.cv=model5.df$crps.cv,
        model6.ln.cv=model6.df$crps.cv,
        model7.1.ln.cv=model7.1.df$crps.cv,
        model7.2.ln.cv=model7.2.df$crps.cv,
        model7.3.ln.cv=model7.3.df$crps.cv,
        model7.4.ln.cv=model7.4.df$crps.cv,
        model7.5.ln.cv=model7.5.df$crps.cv,
        model7.6.tn.cv = model7.6.df$crps.cv,
        model8.tn = model8.df$crps.cv,
        model9.ln = model9.df$crps.cv,
        model10.tn=model10.df$crps.cv,
        model11.tn=model11.df$crps.cv)
rownames(crps.all.cv)<-paste0("lead", seq(6,48,by=6))

sort(colSums(crps.all.cv))

dftest <- melt(crps.all.cv,  id.vars = 'lead', variable.name = 'model')
ggplot(dftest, aes(lead,value))+geom_line(aes(colour=model))

```
# Plots of the weighting methods

Best: Model 3 = linear weights control --> mini ens 6

```{r,include=F,eval=F}
ggplot(dftest[17:64,], aes(lead,value))+geom_line(aes(colour=model))+ggtitle("Weighting methods: TN")
ggplot(dftest[1:64,], aes(lead,value))+geom_line(aes(colour=model))+ggtitle("All methods: TN")
```

```{r,include=F,eval=F}
ggplot(dftest[89:136,], aes(lead,value))+geom_line(aes(colour=model))+ggtitle("Weighting methods: LN")
ggplot(dftest[73:136,], aes(lead,value))+geom_line(aes(colour=model))+ggtitle("All methods: LN")

```




#   Model comparisons
  
Which model is better? Brier (Skill) Score of model 2 & 5. 


```{r}
par(mfrow=c(4,3))
for (j in 1:10){
  plot(y=as.numeric(bs5[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Skill Score Mod 2 & 5,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Skill Score")
  lines(y=as.numeric(bs[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),col="red")
  abline(h=0)}
```

```{r}
par(mfrow=c(4,3))
for (j in 1:12){
  plot(y=as.numeric(bs5[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Score: Mod 2 & 5,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Score")
  lines(y=as.numeric(bs[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),col="red")
  abline(h=0)}
```

##    Model 3 vs 5 
Which is better: TN and LN for exchangeable ensembles: RED = TN, 


```{r}
par(mfrow=c(4,3))
for (j in 1:10){
  plot(y=as.numeric(bs6[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Skill Score Mod 3 & 6,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Skill Score")
  lines(y=as.numeric(bs3[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),col="red")
  abline(h=0)}
```

```{r}
par(mfrow=c(4,3))
for (j in 1:12){
  plot(y=as.numeric(bs6[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Score: Mod 3 & 6,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Score")
  lines(y=as.numeric(bs3[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),col="red")
  abline(h=0)}
```

##    Model 4 versus 7

###   Plot CRPS
```{r}
totalcv.mod4_mod7<- data.frame(
  lead=seq(6,48,by=6),
model4.1.tn.totalcv=model4.1.df$crps.totalcv,
        model4.2.tn.totalcv=model4.2.df$crps.totalcv,
        model4.3.tn.totalcv=model4.3.df$crps.totalcv,
        model4.4.tn.totalcv=model4.4.df$crps.totalcv,
        model4.5.tn.totalcv = model4.5.df$crps.totalcv,
        model4.6.tn.totalcv = model4.6.df$crps.totalcv,
        model7.1.ln.totalcv=model7.1.df$crps.totalcv,
        model7.2.ln.totalcv=model7.2.df$crps.totalcv,
        model7.3.ln.totalcv=model7.3.df$crps.totalcv,
        #model7.4.ln.totalcv=model7.4.df$crps.totalcv,
        model7.5.ln.totalcv=model7.5.df$crps.totalcv,
        model7.6.tn.totalcv = model7.6.df$crps.totalcv)
dftest <- melt(totalcv.mod4_mod7,  id.vars = 'lead', variable.name = 'model')
ggplot(dftest, aes(lead,value))+geom_line(aes(colour=model))
dftest2 <- melt(totalcv.mod4_mod7[1:7],  id.vars = 'lead', variable.name = 'model')
ggplot(dftest2, aes(lead,value))+geom_line(aes(colour=model))

```


###   4.1 & 7.1

```{r}
par(mfrow=c(4,3))
for (j in 1:10){
  plot(y=as.numeric(bs7.1[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Skill Score Mod 4.1 & 7.1,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Skill Score")
  lines(y=as.numeric(bs4.1[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),col="red")
  abline(h=0)}
```

```{r}
par(mfrow=c(4,3))
for (j in 1:12){
  plot(y=as.numeric(bs7.1[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Score: Mod 4.1 & 7.1,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Score")
  lines(y=as.numeric(bs4.1[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),col="red")
  abline(h=0)}
```


###   4.2 & 7.2

```{r}
par(mfrow=c(4,3))
for (j in 1:10){
  plot(y=as.numeric(bs7.2[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Skill Score Mod 4.2 & 7.2,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Skill Score")
  lines(y=as.numeric(bs4.2[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),col="red")
  abline(h=0)}
```

```{r}
par(mfrow=c(4,3))
for (j in 1:12){
  plot(y=as.numeric(bs7.2[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Score: Mod 4.2 & 7.2,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Score")
  lines(y=as.numeric(bs4.2[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),col="red")
  abline(h=0)}
```

###   4.3 & 7.3
+
```{r}
par(mfrow=c(4,3))
for (j in 1:10){
  plot(y=as.numeric(bs7.3[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Skill Score Mod 4.3 & 7.3,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Skill Score")
  lines(y=as.numeric(bs4.3[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),col="red")
  abline(h=0)}
```

```{r}
par(mfrow=c(4,3))
for (j in 1:12){
  plot(y=as.numeric(bs7.3[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Score: Mod 4.3 & 7.3,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Score")
  lines(y=as.numeric(bs4.3[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),col="red")
  abline(h=0)}
```

###   4.4 & 7.4
```{r}
par(mfrow=c(4,3))
for (j in 1:10){
  plot(y=as.numeric(bs7.4[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Skill Score Mod 4.4 & 7.4,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Skill Score")
  lines(y=as.numeric(bs4.4[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),col="red")
  abline(h=0)}
```

```{r}
par(mfrow=c(4,3))
for (j in 1:12){
  plot(y=as.numeric(bs7.4[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Score: Mod 4.4 & 7.4,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Score")
  lines(y=as.numeric(bs4.4[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),col="red")
  abline(h=0)}
```
###   4.5 & 7.5
```{r}
par(mfrow=c(4,3))
for (j in 1:10){
  plot(y=as.numeric(bs7.5[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Skill Score Mod 4.5 & 7.5,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Skill Score")
  lines(y=as.numeric(bs4.5[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),col="red")
  abline(h=0)}
```

```{r}
par(mfrow=c(4,3))
for (j in 1:12){
  plot(y=as.numeric(bs7.5[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Score: Mod 4.5 & 7.5,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Score")
  lines(y=as.numeric(bs4.5[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),col="red")
  abline(h=0)}
```

###   4.6 & 7.6
```{r}
par(mfrow=c(4,3))
for (j in 1:10){
  plot(y=as.numeric(bs7.6[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Skill Score Mod 4.6 & 7.6,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Skill Score")
  lines(y=as.numeric(bs4.6[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),col="red")
  abline(h=0)}
```

```{r}
par(mfrow=c(4,3))
for (j in 1:12){
  plot(y=as.numeric(bs7.6[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Score: Mod 4.6 & 7.6,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Score")
  lines(y=as.numeric(bs4.6[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),col="red")
  abline(h=0)}
```

```{r}
par(mfrow=c(3,2))
for (j in 4:9){
   plot(y=as.numeric(bs7.1[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Score: Mod 4.4 & 7.4,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Score")
  lines(y=as.numeric(bs4.1[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),col="red")
  abline(h=0)
   lines(y=as.numeric(bs7.2[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Score: Mod 4.4 & 7.4,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Score")
  lines(y=as.numeric(bs4.2[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),col="red")
  abline(h=0)
  lines(y=as.numeric(bs7.3[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Score: Mod 4.4 & 7.4,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Score")
  lines(y=as.numeric(bs4.3[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),col="red")
  abline(h=0)
lines(y=as.numeric(bs7.5[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Score: Mod 4.5 & 7.5,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Score")
  lines(y=as.numeric(bs4.5[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),col="red")
  abline(h=0)
lines(y=as.numeric(bs7.6[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Score: Mod 4.6 & 7.6,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Score")
  lines(y=as.numeric(bs4.6[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),col="red")
  abline(h=0)}
```

```{r}

par(mfrow=c(3,2))
for (j in 4:9){
   plot(y=as.numeric(bs7.1[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier Skill score,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Skill Score")
  lines(y=as.numeric(bs4.1[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),col=1,lty=2)
   lines(y=as.numeric(bs7.2[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),col=3)
  lines(y=as.numeric(bs4.2[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),col=3,lty=2)
  lines(y=as.numeric(bs4.3[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),col="purple",lty=2)
lines(y=as.numeric(bs7.5[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),col="blue")
  lines(y=as.numeric(bs4.5[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),col="blue",lty=2)
lines(y=as.numeric(bs7.6[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),col="orange")
  lines(y=as.numeric(bs4.6[j,c(seq(3,17,by=2))]),x=seq(6,48,by=6),col="orange",lty=2) }
  
```

- blue lines: are the worst: that is model 4.5/7.5 (no control). 
- Orange/red: seem to both be good (model 4.1,4.2,4.6)

```{r}
par(mfrow=c(3,2))
for (j in 4:9){
   plot(y=as.numeric(bs7.1[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),type="l", main= paste0("Brier score,  threshold ",seq(2,24,by=2)[j]), xlab = "Lead time", ylab="Brier Score", col="black")
  lines(y=as.numeric(bs4.1[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),col="black",lty=2)
   lines(y=as.numeric(bs7.2[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),col="green")
  lines(y=as.numeric(bs4.2[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),col="green",lty=2)
  lines(y=as.numeric(bs4.3[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),col="purple",lty=2)
lines(y=as.numeric(bs7.5[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),col="blue")
  lines(y=as.numeric(bs4.5[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),col="blue",lty=2)
lines(y=as.numeric(bs7.6[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),col="orange")
  lines(y=as.numeric(bs4.6[j,c(seq(2,17,by=2))]),x=seq(6,48,by=6),col="orange",lty=2) }
  
```

For the brier score, the lower the better. We see that the .. and .. are often performing better, but only for the higher threshold (18) the blue line seems to be best. The purple line seems to be the lowest everywhere (or at least never the highest). 
 Here the blue line does look a bit better, than the others so we definetly want model 4.5 & 7.5

